const MIN_DISPLAYED_CARDS=10;let engineersList=[...engineers];shuffle(engineersList);let activeFilters=[];let filteredEngineers=[...engineersList];let displayedEngineers=[...engineersList];let isDragging=false;let startX=0;let startY=0;let startRotation=0;let currentDisplayedIndex=0;let lastMouseX=0;let lastMouseTime=0;let velocity=0;const friction=0.95;let inertiaFrame=null;let isAnimating=false;let pendingMovement=0;let isMobile=false;let justClicked=false;let mouseButtonDown=false;let currentFilteredIndex=0;function announceToScreenReader(message){const srElement=document.getElementById('sr-instructions');if(srElement){srElement.textContent=message;setTimeout(()=>{srElement.textContent='';},3000);}}
function isMobileDevice(){return window.innerWidth<=768&&('ontouchstart'in window);}
function parseThemeHierarchy(theme){const parts=theme.split(':::');return{category:parts[0]||'',subcategory:parts[1]||'',keyword:parts[2]||parts[parts.length-1]||'',fullTheme:theme};}
function extractThemeHierarchy(){const hierarchy={};const allThemes=new Set();engineersList.forEach(engineer=>{if(engineer.themes&&Array.isArray(engineer.themes)){engineer.themes.forEach(theme=>{allThemes.add(theme);const parsed=parseThemeHierarchy(theme);const category=parsed.category;const subcategory=parsed.subcategory;if(!hierarchy[category]){hierarchy[category]={};}
if(subcategory&&!hierarchy[category][subcategory]){hierarchy[category][subcategory]=[];}
if(subcategory){if(!hierarchy[category][subcategory].includes(theme)){hierarchy[category][subcategory].push(theme);}}});}});Object.keys(hierarchy).forEach(category=>{Object.keys(hierarchy[category]).forEach(subcategory=>{hierarchy[category][subcategory].sort((a,b)=>{const aKeyword=parseThemeHierarchy(a).keyword;const bKeyword=parseThemeHierarchy(b).keyword;return aKeyword.localeCompare(bKeyword);});});});return hierarchy;}
function extractUniqueThemes(){const allThemes=[];engineersList.forEach(engineer=>{if(engineer.themes&&Array.isArray(engineer.themes)){engineer.themes.forEach(theme=>{if(!allThemes.includes(theme)){allThemes.push(theme);}});}});return allThemes.sort((a,b)=>{const aKeyword=parseThemeHierarchy(a).keyword;const bKeyword=parseThemeHierarchy(b).keyword;return aKeyword.localeCompare(bKeyword);});}
function countEngineersWithTheme(theme){return engineersList.filter(engineer=>engineer.themes&&Array.isArray(engineer.themes)&&engineer.themes.includes(theme)).length;}
function generateDisplayedEngineers(){if(filteredEngineers.length===0){displayedEngineers=[];return;}
if(filteredEngineers.length===1){displayedEngineers=[...filteredEngineers];}else if(filteredEngineers.length>=8){displayedEngineers=[...filteredEngineers];}else{displayedEngineers=[];let targetCount;if(filteredEngineers.length===2){targetCount=10;}else if(filteredEngineers.length===3){targetCount=12;}else if(filteredEngineers.length===4){targetCount=12;}else if(filteredEngineers.length===5){targetCount=10;}else{targetCount=Math.max(MIN_DISPLAYED_CARDS,filteredEngineers.length*2);}
for(let i=0;i<targetCount;i++){const originalIndex=i%filteredEngineers.length;displayedEngineers.push({...filteredEngineers[originalIndex],_duplicateIndex:i,_originalIndex:originalIndex});}}}
function resetState(){const cards=document.querySelectorAll(".engineer-card");cards.forEach(card=>{card.style.transition="none";});startRotation=currentDisplayedIndex;velocity=0;lastMouseX=0;lastMouseTime=0;}
function findFrontmostDisplayedIndex(position){if(displayedEngineers.length===0)return-1;if(displayedEngineers.length===1)return 0;let normalizedPosition=position;while(normalizedPosition<0){normalizedPosition+=displayedEngineers.length;}
while(normalizedPosition>=displayedEngineers.length){normalizedPosition-=displayedEngineers.length;}
return Math.round(normalizedPosition)%displayedEngineers.length;}
function findNextDisplayedIndex(currentIdx){if(displayedEngineers.length===0)return-1;if(displayedEngineers.length===1)return 0;if(currentIdx<0||currentIdx>=displayedEngineers.length){return 0;}
return(currentIdx+1)%displayedEngineers.length;}
function findPrevDisplayedIndex(currentIdx){if(displayedEngineers.length===0)return-1;if(displayedEngineers.length===1)return 0;if(currentIdx<0||currentIdx>=displayedEngineers.length){return displayedEngineers.length-1;}
return(currentIdx-1+displayedEngineers.length)%displayedEngineers.length;}
function updateEngineerDetails(displayedIdx){try{if(displayedIdx<0||displayedIdx>=displayedEngineers.length){console.error("Index invalide pour la mise à jour des détails:",displayedIdx);return;}
const displayedEngineer=displayedEngineers[displayedIdx];let engineer;if(displayedEngineer._originalIndex!==undefined){engineer=filteredEngineers[displayedEngineer._originalIndex];}else{engineer=displayedEngineer;}
const selectionInfo=document.getElementById("selectionInfo");const selectionImage=document.getElementById("selectionImage");const selectionName=document.getElementById("selectionName");const selectionRole=document.getElementById("selectionRole");const selectionBio=document.getElementById("selectionBio");const linksContainer=document.getElementById("selectionLinks");if(!selectionInfo||!selectionImage||!selectionName||!selectionRole||!selectionBio||!linksContainer){console.error("Un ou plusieurs éléments de sélection sont manquants dans le DOM");return;}
selectionImage.style.backgroundImage=`url('${engineer.image || "/api/placeholder/400/400"}')`;selectionImage.setAttribute('aria-label',`Photo de profil de ${engineer.name||'Ingénieur'}`);selectionName.textContent=engineer.name||"";selectionRole.textContent=engineer.company||"";selectionBio.textContent=engineer.bio||"";const oldThemesContainer=document.querySelector('.selection-themes');if(oldThemesContainer){oldThemesContainer.remove();}
if(engineer.themes&&Array.isArray(engineer.themes)&&engineer.themes.length>0){const themesContainer=document.createElement('div');themesContainer.className='selection-themes';themesContainer.setAttribute('role','list');themesContainer.setAttribute('aria-label','Domaines d\'expertise');const themesByCategory={};engineer.themes.forEach(theme=>{const parsed=parseThemeHierarchy(theme);const category=parsed.category;if(!themesByCategory[category]){themesByCategory[category]=[];}
themesByCategory[category].push({keyword:parsed.keyword,fullTheme:theme});});Object.keys(themesByCategory).sort().forEach(category=>{const categoryContainer=document.createElement('div');categoryContainer.className='selection-theme-category';const categoryTitle=document.createElement('div');categoryTitle.className='selection-theme-category-title';categoryTitle.textContent=category;categoryContainer.appendChild(categoryTitle);const categoryThemes=document.createElement('div');categoryThemes.className='selection-theme-category-themes';const uniqueThemes=themesByCategory[category].reduce((acc,current)=>{if(!acc.find(item=>item.keyword===current.keyword)){acc.push(current);}
return acc;},[]).sort((a,b)=>a.keyword.localeCompare(b.keyword));uniqueThemes.forEach(({keyword,fullTheme})=>{const themeSpan=document.createElement('span');themeSpan.className='selection-theme';themeSpan.textContent=keyword;themeSpan.setAttribute('role','listitem');themeSpan.setAttribute('tabindex','0');themeSpan.setAttribute('aria-label',`Cliquer pour filtrer par ${keyword}`);themeSpan.addEventListener('click',function(){toggleThemeFilter(fullTheme);});themeSpan.addEventListener('keydown',function(e){if(e.key==='Enter'||e.key===' '){e.preventDefault();toggleThemeFilter(fullTheme);}});categoryThemes.appendChild(themeSpan);});categoryContainer.appendChild(categoryThemes);themesContainer.appendChild(categoryContainer);});selectionBio.insertAdjacentElement('afterend',themesContainer);}
linksContainer.innerHTML='';if(engineer.links&&Array.isArray(engineer.links)&&engineer.links.length>0){engineer.links.forEach(link=>{if(!link.url||link.url.trim()===''){return;}
const linkElement=document.createElement('a');linkElement.href=link.url;linkElement.className='selection-link';linkElement.target='_blank';linkElement.rel='noopener noreferrer';if(link.type==='linkedin'){linkElement.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true"><path d="M16 8a6 6 0 0 1 6 6v7h-4v-7a2 2 0 0 0-2-2 2 2 0 0 0-2 2v7h-4v-7a6 6 0 0 1 6-6z"></path><rect x="2" y="9" width="4" height="12"></rect><circle cx="4" cy="4" r="2"></circle></svg> LinkedIn';linkElement.setAttribute('aria-label',`Profil LinkedIn de ${engineer.name}(s'ouvre dans un nouvel onglet)`);
				} else if (link.type === 'website') {
					linkElement.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg"width="16"height="16"viewBox="0 0 24 24"fill="none"stroke="currentColor"stroke-width="2"stroke-linecap="round"stroke-linejoin="round"aria-hidden="true"><circle cx="12"cy="12"r="10"></circle><line x1="2"y1="12"x2="22"y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>Site Web';
					linkElement.setAttribute('aria-label', `Site web de ${engineer.name} (s'ouvre dans un nouvel onglet)`);}else{linkElement.textContent=link.url;linkElement.setAttribute('aria-label',`Lien vers ${link.url}(s'ouvre dans un nouvel onglet)`);
				}
				linksContainer.appendChild(linkElement);
			});
		}
        
        selectionInfo.classList.add("visible");
        
        // AMÉLIORATION ARIA: Annoncer le changement
        announceToScreenReader(`Ingénieur sélectionné : ${engineer.name}, ${engineer.company}`);
        
    } catch (error) {
        console.error("Erreur lors de la mise à jour des détails:", error);
    }
}

/**
 * Met à jour la carte mise en évidence et ses détails
 * @param {number} displayedIdx - Index dans displayedEngineers à mettre en évidence
 */
function updateHighlightedCard(displayedIdx) {
    if (displayedIdx < 0 || displayedIdx >= displayedEngineers.length) return;
    
    // Mettre à jour toutes les cartes
    const cards = document.querySelectorAll(".engineer-card");
    
    // Retirer la classe selected de toutes les cartes
    cards.forEach((card, index) => {
        card.classList.remove("selected");
        // AMÉLIORATION ARIA: Mettre à jour les attributs
        card.setAttribute('aria-selected', 'false');
        card.setAttribute('tabindex', '-1');
    });
    
    // Mettre à jour la carte sélectionnée
    if (cards[displayedIdx]) {
        cards[displayedIdx].classList.add("selected");
        // AMÉLIORATION ARIA: Marquer comme sélectionnée
        cards[displayedIdx].setAttribute('aria-selected', 'true');
        cards[displayedIdx].setAttribute('tabindex', '0');
    }
    
    // Mettre à jour les détails
    updateEngineerDetails(displayedIdx);
}

/**
 * Sélectionne un ingénieur par son index affiché et affiche ses détails
 * @param {number} displayedIdx - Index dans displayedEngineers de l'ingénieur à sélectionner*/
function selectEngineer(displayedIdx){try{if(displayedEngineers.length===0){console.warn("Aucun ingénieur à sélectionner");return;}
if(displayedIdx<0||displayedIdx>=displayedEngineers.length){console.error("Index invalide pour la sélection:",displayedIdx);displayedIdx=0;}
currentDisplayedIndex=displayedIdx;rotateCarousel(displayedIdx,false);updateHighlightedCard(displayedIdx);}catch(error){console.error("Erreur lors de la sélection de l'ingénieur:",error);currentDisplayedIndex=0;rotateCarousel(0,false);updateHighlightedCard(0);}}
function rotateCarousel(displayedPosition,animate){if(filteredEngineers.length===0)return;const count=displayedEngineers.length;const calculations={radius:count===1?0:Math.min(180+(count*12),500),angleIncrement:count>1?360/count:0};const cards=document.querySelectorAll(".engineer-card");if(animate){cards.forEach(card=>{card.style.transition="transform 0.5s ease-out";});}
const frontCardDisplayedIndex=findFrontmostDisplayedIndex(displayedPosition);if(frontCardDisplayedIndex!==-1){updateHighlightedCard(frontCardDisplayedIndex);}
const cardUpdates=[];cards.forEach((card,cardIndex)=>{if(cardIndex>=displayedEngineers.length)return;let positionDiff=cardIndex-displayedPosition;const halfLength=displayedEngineers.length/2;while(positionDiff>halfLength)positionDiff-=displayedEngineers.length;while(positionDiff<-halfLength)positionDiff+=displayedEngineers.length;const angle=count===1?0:(positionDiff*calculations.angleIncrement)*Math.PI/180;const x=count===1?0:calculations.radius*Math.sin(angle);const zDepthFactor=Math.cos(angle);const zDepth=(zDepthFactor+1)/2;const z=count===1?0:-calculations.radius*(1-zDepth*0.4);const baseScale=1.2;let scale;if(count===1){scale=1.0;}else{const angleDiff=Math.abs(positionDiff*calculations.angleIncrement);const scaleReduction=Math.min(angleDiff,180)/180*0.3;scale=baseScale*(1-scaleReduction);}
cardUpdates.push({card,x,z,scale,distance:Math.abs(positionDiff)});});cardUpdates.forEach(({card,x,z,scale,distance})=>{card.style.transform=`translateX(${x}px)translateZ(${z}px)scale(${scale})`;card.style.zIndex=100-Math.round(distance*10);card.classList.remove("filtered-out","inactive");});if(animate){setTimeout(()=>{cards.forEach(card=>card.style.transition="none");resetState();},400);}}
function triggerMovement(delta){if(displayedEngineers.length<=1)return;if(isAnimating){pendingMovement+=delta;return;}
let newDisplayedIndex;if(delta>0){newDisplayedIndex=findNextDisplayedIndex(Math.round(currentDisplayedIndex));}else{newDisplayedIndex=findPrevDisplayedIndex(Math.round(currentDisplayedIndex));}
animateToIndex(newDisplayedIndex);}
function processPendingMovement(){if(pendingMovement===0)return;const direction=pendingMovement>0?1:-1;pendingMovement-=direction;let currentRoundedIndex=Math.round(currentDisplayedIndex);if(currentRoundedIndex<0||currentRoundedIndex>=displayedEngineers.length){currentRoundedIndex=0;currentDisplayedIndex=0;}
let newDisplayedIndex;if(direction>0){newDisplayedIndex=findNextDisplayedIndex(currentRoundedIndex);}else{newDisplayedIndex=findPrevDisplayedIndex(currentRoundedIndex);}
animateToIndex(newDisplayedIndex);}
function animateToIndex(targetDisplayedIndex){const timestamp=Date.now();console.log(`${timestamp}-animateToIndex:targetIndex received=`,targetDisplayedIndex,"currentDisplayedIndex at start =",currentDisplayedIndex);if(targetDisplayedIndex<0||targetDisplayedIndex>=displayedEngineers.length){targetDisplayedIndex=0;}
isAnimating=true;const baseDuration=400;const pendingCount=Math.abs(pendingMovement);const duration=pendingCount>1?baseDuration/pendingCount:baseDuration;const cards=document.querySelectorAll(".engineer-card");cards.forEach(card=>{card.style.transition=`transform ${duration}ms ease-out`;});currentDisplayedIndex=targetDisplayedIndex;rotateCarousel(currentDisplayedIndex,true);setTimeout(()=>{cards.forEach(card=>{card.style.transition="none";});resetState();isAnimating=false;if(pendingMovement!==0){setTimeout(()=>{processPendingMovement();},50);}},duration+50);}
function applyThemeFilters(){const previousLength=filteredEngineers.length;if(activeFilters.length===0){filteredEngineers=[...engineersList];}else{filteredEngineers=engineersList.filter(engineer=>{if(!engineer.themes||!Array.isArray(engineer.themes)){return false;}
return activeFilters.every(theme=>engineer.themes.includes(theme));});}
currentFilteredIndex=0;updateThemeFilterCounts();updateCarouselDisplay();if(activeFilters.length>0){const resultText=filteredEngineers.length===0?"Aucun membre ne correspond aux filtres sélectionnés":`${filteredEngineers.length}membre${filteredEngineers.length>1?'s':''}trouvé${filteredEngineers.length>1?'s':''}`;announceToScreenReader(resultText);}}
function updateThemeFilterCounts(){const allThemes=extractUniqueThemes();allThemes.forEach(theme=>{const btn=document.querySelector(`.theme-btn[data-theme="${theme}"]`);if(!btn)return;let count=0;if(activeFilters.length===0){count=countEngineersWithTheme(theme);}else{count=filteredEngineers.filter(engineer=>engineer.themes&&Array.isArray(engineer.themes)&&engineer.themes.includes(theme)).length;}
const countSpan=btn.querySelector('.count');if(countSpan){countSpan.textContent=count;}
if(count===0&&!activeFilters.includes(theme)){btn.classList.add('disabled');}else{btn.classList.remove('disabled');}
if(activeFilters.includes(theme)){btn.classList.add('active');btn.setAttribute('aria-pressed','true');}else{btn.classList.remove('active');btn.setAttribute('aria-pressed','false');}});}
function updateCarouselDisplay(){const carousel=document.getElementById("engineerCarousel");const existingNoResults=document.querySelector('.no-results-message');if(existingNoResults){existingNoResults.remove();}
if(filteredEngineers.length===0){if(carousel){const noResultsMessage=document.createElement('div');noResultsMessage.className='no-results-message';noResultsMessage.textContent='Aucun membre ne correspond à tous les critères sélectionnés.';noResultsMessage.setAttribute('role','status');noResultsMessage.setAttribute('aria-live','polite');carousel.appendChild(noResultsMessage);}
const selectionInfo=document.getElementById("selectionInfo");if(selectionInfo){selectionInfo.classList.remove("visible");}
const prevBtn=document.getElementById("prevBtn");const nextBtn=document.getElementById("nextBtn");if(prevBtn)prevBtn.disabled=true;if(nextBtn)nextBtn.disabled=true;return;}else{const prevBtn=document.getElementById("prevBtn");const nextBtn=document.getElementById("nextBtn");if(prevBtn)prevBtn.disabled=false;if(nextBtn)nextBtn.disabled=false;generateDisplayedEngineers();recreateCarouselCards();currentDisplayedIndex=0;rotateCarousel(currentDisplayedIndex,false);updateHighlightedCard(currentDisplayedIndex);}}
function toggleThemeFilter(theme){try{if(!theme)return;const index=activeFilters.indexOf(theme);if(index===-1){activeFilters.push(theme);}else{activeFilters.splice(index,1);}
applyThemeFilters();}catch(error){console.error("Erreur dans toggleThemeFilter:",error);}}
function clearThemeFilters(){activeFilters=[];applyThemeFilters();announceToScreenReader("Tous les filtres ont été effacés");}
function recreateCarouselCards(){const carousel=document.getElementById("engineerCarousel");if(!carousel)return;carousel.innerHTML='';displayedEngineers.forEach((displayedEngineer,displayIndex)=>{let originalEngineer;if(displayedEngineer._originalIndex!==undefined){originalEngineer=filteredEngineers[displayedEngineer._originalIndex];}else{originalEngineer=displayedEngineer;}
const card=document.createElement("div");card.className="engineer-card";card.setAttribute("data-display-index",displayIndex);card.setAttribute("role","button");card.setAttribute("tabindex",displayIndex===0?"0":"-1");card.setAttribute("aria-selected",displayIndex===0?"true":"false");card.setAttribute("aria-label",`Sélectionner ${originalEngineer.name},${originalEngineer.company}`);let html=`<div class="engineer-image"style="background-image: url('${originalEngineer.image || "/api/placeholder/400/400"}')"role="img"aria-label="Photo de ${originalEngineer.name}"></div><div class="engineer-info"><div class="engineer-name">${originalEngineer.name||""}</div><div class="engineer-company">${originalEngineer.company||""}</div><div class="engineer-themes-container"><div class="engineer-themes"role="list"aria-label="Domaines d'expertise">`;if(originalEngineer.themes&&Array.isArray(originalEngineer.themes)&&originalEngineer.themes.length>0){const themesByCategory={};originalEngineer.themes.forEach(theme=>{const parsed=parseThemeHierarchy(theme);const category=parsed.category;if(!themesByCategory[category]){themesByCategory[category]=[];}
themesByCategory[category].push(parsed.keyword);});Object.keys(themesByCategory).forEach(category=>{const uniqueKeywords=[...new Set(themesByCategory[category])].sort();uniqueKeywords.forEach(keyword=>{html+=`<span class="engineer-theme"role="listitem">${keyword}</span>`;});});}
html+=`</div></div></div>`;card.innerHTML=html;card.addEventListener("click",(e)=>{e.stopPropagation();justClicked=true;let filteredIndex;if(displayedEngineer._originalIndex!==undefined){filteredIndex=displayedEngineer._originalIndex;}else{filteredIndex=filteredEngineers.indexOf(originalEngineer);}
if(filteredIndex!==-1){selectEngineer(filteredIndex);}
setTimeout(()=>{justClicked=false;},300);});card.addEventListener("keydown",(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();card.click();}else if(e.key==='ArrowLeft'){e.preventDefault();triggerMovement(-1);}else if(e.key==='ArrowRight'){e.preventDefault();triggerMovement(1);}});carousel.appendChild(card);});}
function initializeThemeFilters(){try{const hierarchy=extractThemeHierarchy();const filterContainer=document.getElementById('themeFilters');if(!filterContainer){console.error("Conteneur de filtres introuvable");return;}
filterContainer.innerHTML='';const categoryOrder=["GÉRER & ORGANISER","CONCEVOIR","FABRIQUER","PARTAGER & FORMER"];const sortedCategories=Object.keys(hierarchy).sort((a,b)=>{const indexA=categoryOrder.indexOf(a);const indexB=categoryOrder.indexOf(b);if(indexA!==-1&&indexB!==-1){return indexA-indexB;}
if(indexA!==-1)return-1;if(indexB!==-1)return 1;return a.localeCompare(b);});sortedCategories.forEach(category=>{const categorySection=document.createElement('div');categorySection.className='filter-category';const categoryHeader=document.createElement('h3');categoryHeader.className='filter-category-title';categoryHeader.textContent=category;categorySection.appendChild(categoryHeader);const subcategoriesContainer=document.createElement('div');subcategoriesContainer.className='filter-subcategories';Object.keys(hierarchy[category]).sort().forEach(subcategory=>{const subcategorySection=document.createElement('div');subcategorySection.className='filter-subcategory';const subcategoryHeader=document.createElement('div');subcategoryHeader.className='filter-subcategory-title';subcategoryHeader.textContent=subcategory;subcategoryHeader.setAttribute('role','button');subcategoryHeader.setAttribute('tabindex','0');const subcategoryContent=document.createElement('div');subcategoryContent.className='filter-subcategory-content';subcategoryHeader.setAttribute('aria-expanded','true');subcategoryHeader.classList.add('expanded');subcategoryContent.style.display='block';hierarchy[category][subcategory].forEach(theme=>{const count=countEngineersWithTheme(theme);const btn=document.createElement('button');btn.className='theme-btn';btn.dataset.theme=theme;const parsed=parseThemeHierarchy(theme);btn.innerHTML=`${parsed.keyword}<span class="count">${count}</span>`;btn.setAttribute('type','button');btn.setAttribute('role','button');btn.setAttribute('aria-pressed','false');btn.setAttribute('aria-label',`Filtrer par ${parsed.keyword},${count}membre${count>1?'s':''}`);btn.addEventListener('click',()=>{toggleThemeFilter(theme);});subcategoryContent.appendChild(btn);});subcategoryHeader.addEventListener('click',()=>{const isExpanded=subcategoryHeader.getAttribute('aria-expanded')==='true';subcategoryHeader.setAttribute('aria-expanded',!isExpanded);subcategoryContent.style.display=isExpanded?'none':'block';subcategoryHeader.classList.toggle('expanded',!isExpanded);});subcategoryHeader.addEventListener('keydown',(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();subcategoryHeader.click();}});subcategorySection.appendChild(subcategoryHeader);subcategorySection.appendChild(subcategoryContent);subcategoriesContainer.appendChild(subcategorySection);});categorySection.appendChild(subcategoriesContainer);filterContainer.appendChild(categorySection);});const clearBtn=document.createElement('button');clearBtn.className='theme-clear';clearBtn.textContent='Effacer tous les filtres';clearBtn.setAttribute('type','button');clearBtn.setAttribute('aria-label','Effacer tous les filtres');clearBtn.addEventListener('click',clearThemeFilters);filterContainer.appendChild(clearBtn);const filterInfo=document.createElement('div');filterInfo.className='filter-info';filterInfo.innerHTML='Cliquez sur les titres pour replier les sections • Sélectionnez plusieurs thèmes pour un filtrage combiné';filterInfo.setAttribute('role','note');filterContainer.appendChild(filterInfo);}catch(error){console.error("Erreur dans initializeThemeFilters:",error);}}
function isInsideCarouselArea(clientX,clientY,rect){return(clientX>=rect.left&&clientX<=rect.right&&clientY>=rect.top&&clientY<=rect.bottom);}
function endDraggingWithAnimation(){isDragging=false;if(filteredEngineers.length<=1)return;const frontmostIndex=findFrontmostDisplayedIndex(currentDisplayedIndex);const timestamp=Date.now();console.log(`${timestamp}-endDragging:BEFORE animateToIndex-frontmostIndex=`,frontmostIndex,"currentDisplayedIndex=",currentDisplayedIndex);if(frontmostIndex!==-1){animateToIndex(frontmostIndex);console.log(`${timestamp}-endDragging:AFTER animateToIndex-targetIndex=`,frontmostIndex);}else{const roundedIndex=Math.round(currentDisplayedIndex);animateToIndex(roundedIndex);console.log(`${timestamp}-endDragging:AFTER animateToIndex(rounded)-targetIndex=`,roundedIndex);}}
function setupDeviceSpecificEventListeners(){const carouselContainer=document.querySelector(".carousel-container");if(!carouselContainer){console.error("Conteneur du carrousel introuvable");return;}
isMobile=isMobileDevice();console.log("Appareil détecté comme",isMobile?"mobile":"desktop");document.body.classList.toggle('mobile-device',isMobile);const prevBtn=document.getElementById("prevBtn");const nextBtn=document.getElementById("nextBtn");if(prevBtn){prevBtn.addEventListener("click",(e)=>{e.preventDefault();triggerMovement(-1);});}
if(nextBtn){nextBtn.addEventListener("click",(e)=>{e.preventDefault();triggerMovement(1);});}
document.addEventListener("keydown",(e)=>{if(e.key==="ArrowLeft"){e.preventDefault();triggerMovement(-1);}else if(e.key==="ArrowRight"){e.preventDefault();triggerMovement(1);}});if(!isMobile){carouselContainer.addEventListener("wheel",(e)=>{const isHorizontal=Math.abs(e.deltaX)>Math.abs(e.deltaY);if(isHorizontal){e.preventDefault();const direction=e.deltaX>0?1:-1;clearTimeout(window.scrollTimeout);window.scrollTimeout=setTimeout(()=>{triggerMovement(direction);},100);}
},{passive:false});document.addEventListener("mousedown",()=>{mouseButtonDown=true;});document.addEventListener("mouseup",()=>{mouseButtonDown=false;});carouselContainer.addEventListener("mousedown",(e)=>{e.preventDefault();if(inertiaFrame){cancelAnimationFrame(inertiaFrame);inertiaFrame=null;}
if(isAnimating){isAnimating=false;pendingMovement=0;const cards=document.querySelectorAll(".engineer-card");cards.forEach(card=>{card.style.transition="none";});}
resetState();isDragging=true;startX=e.clientX;startRotation=currentDisplayedIndex;lastMouseX=e.clientX;lastMouseTime=performance.now();carouselContainer.style.cursor="grabbing";});document.addEventListener("mousemove",(e)=>{if(!isDragging)return;const rect=carouselContainer.getBoundingClientRect();if(!isInsideCarouselArea(e.clientX,e.clientY,rect)){isDragging=false;carouselContainer.style.cursor="grab";endDraggingWithAnimation();return;}
const now=performance.now();const dt=now-lastMouseTime;if(dt>0){velocity=0.25*(e.clientX-lastMouseX)/dt;}
lastMouseX=e.clientX;lastMouseTime=now;const deltaX=e.clientX-startX;const threshold=120;let deltaIndex=-deltaX/threshold;let newIndex=startRotation+deltaIndex;while(newIndex<0){newIndex+=displayedEngineers.length;}
while(newIndex>=displayedEngineers.length){newIndex-=displayedEngineers.length;}
rotateCarousel(newIndex,false);currentDisplayedIndex=newIndex;});document.addEventListener("mouseup",(e)=>{if(isDragging){if(justClicked){isDragging=false;carouselContainer.style.cursor="grab";return;}
isDragging=false;carouselContainer.style.cursor="grab";endDraggingWithAnimation();}});carouselContainer.addEventListener("mouseleave",()=>{if(isDragging){isDragging=false;carouselContainer.style.cursor="grab";endDraggingWithAnimation();}});}
else{carouselContainer.addEventListener("touchstart",(e)=>{if(inertiaFrame){cancelAnimationFrame(inertiaFrame);inertiaFrame=null;}
if(isAnimating){isAnimating=false;pendingMovement=0;const cards=document.querySelectorAll(".engineer-card");cards.forEach(card=>{card.style.transition="none";});}
resetState();isDragging=true;startX=e.touches[0].clientX;startY=e.touches[0].clientY;startRotation=currentDisplayedIndex;lastMouseX=e.touches[0].clientX;lastMouseTime=performance.now();},{passive:true});carouselContainer.addEventListener("touchmove",(e)=>{if(!isDragging)return;const rect=carouselContainer.getBoundingClientRect();if(!isInsideCarouselArea(e.touches[0].clientX,e.touches[0].clientY,rect)){isDragging=false;endDraggingWithAnimation();return;}
const now=performance.now();const dt=now-lastMouseTime;if(dt>0){velocity=0.25*(e.touches[0].clientX-lastMouseX)/dt;}
lastMouseX=e.touches[0].clientX;lastMouseTime=now;const deltaX=e.touches[0].clientX-startX;const deltaY=e.touches[0].clientY-startY;const isHorizontalMovement=Math.abs(deltaX)>Math.abs(deltaY);if(isHorizontalMovement){const threshold=80;let deltaIndex=-deltaX/threshold;let newIndex=startRotation+deltaIndex;while(newIndex<0){newIndex+=displayedEngineers.length;}
while(newIndex>=displayedEngineers.length){newIndex-=displayedEngineers.length;}
currentDisplayedIndex=newIndex;rotateCarousel(newIndex,false);if(Math.abs(deltaX)>10){e.preventDefault();}}
},{passive:false});carouselContainer.addEventListener("touchend",(e)=>{if(!isDragging)return;isDragging=false;if(Math.abs(velocity)>0.1){if(inertiaFrame)cancelAnimationFrame(inertiaFrame);applyInertiaMobile();}else{endDraggingWithAnimation();}});carouselContainer.addEventListener("touchcancel",(e)=>{if(isDragging){isDragging=false;endDraggingWithAnimation();}});}
window.addEventListener("resize",()=>{const newIsMobile=isMobileDevice();if(newIsMobile!==isMobile){console.log("Type d'appareil changé, reconfiguration des événements");const oldCarousel=document.querySelector(".carousel-container");if(oldCarousel){const newCarousel=oldCarousel.cloneNode(true);oldCarousel.parentNode.replaceChild(newCarousel,oldCarousel);}
setupDeviceSpecificEventListeners();}});}
function initializeCarousel(){try{const carousel=document.getElementById("engineerCarousel");if(!carousel){console.error("Élément du carrousel introuvable dans le DOM");return;}
if(!engineersList||!Array.isArray(engineersList)||engineersList.length===0){console.error("Données des ingénieurs invalides");return;}
carousel.innerHTML='';engineersList.forEach((engineer,index)=>{if(!engineer){console.error(`Ingénieur à l'index ${index} est undefined`);
                return;
            }
            
            // Création de la carte
            const card = document.createElement("div");
            card.className = "engineer-card";
            card.setAttribute("data-engineer-index", index);
            
            // AMÉLIORATIONS ARIA: Attributs d'accessibilité
card.setAttribute("role","button");card.setAttribute("tabindex",index===0?"0":"-1");card.setAttribute("aria-selected",index===0?"true":"false");card.setAttribute("aria-label",`Sélectionner ${engineer.name},${engineer.company}`);let html=`<div class="engineer-image"style="background-image: url('${engineer.image || "/api/placeholder/400/400"}')"role="img"aria-label="Photo de ${engineer.name}"></div><div class="engineer-info"><div class="engineer-name">${engineer.name||""}</div><div class="engineer-company">${engineer.company||""}</div><div class="engineer-themes-container"><div class="engineer-themes"role="list"aria-label="Domaines d'expertise">`;if(engineer.themes&&Array.isArray(engineer.themes)&&engineer.themes.length>0){const themesByCategory={};engineer.themes.forEach(theme=>{const parsed=parseThemeHierarchy(theme);const category=parsed.category;if(!themesByCategory[category]){themesByCategory[category]=[];}
themesByCategory[category].push(parsed.keyword);});Object.keys(themesByCategory).forEach(category=>{const uniqueKeywords=[...new Set(themesByCategory[category])].sort();uniqueKeywords.forEach(keyword=>{html+=`<span class="engineer-theme"role="listitem">${keyword}</span>`;});});}
html+=`</div></div></div>`;card.innerHTML=html;card.addEventListener("click",(e)=>{e.stopPropagation();justClicked=true;const filteredIndex=filteredEngineers.indexOf(engineer);if(filteredIndex!==-1){selectEngineer(filteredIndex);}
setTimeout(()=>{justClicked=false;},300);});card.addEventListener("keydown",(e)=>{if(e.key==='Enter'||e.key===' '){e.preventDefault();card.click();}else if(e.key==='ArrowLeft'){e.preventDefault();triggerMovement(-1);}else if(e.key==='ArrowRight'){e.preventDefault();triggerMovement(1);}});carousel.appendChild(card);});rotateCarousel(0);if(displayedEngineers.length>0){updateHighlightedCard(0);}
try{initializeThemeFilters();}catch(error){console.error("Erreur lors de l'initialisation des filtres:",error);}}catch(error){console.error("Erreur dans initializeCarousel:",error);}}
function shuffle(array){for(let i=array.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[array[i],array[j]]=[array[j],array[i]];}
return array;}
function applyInertiaMobile(){if(displayedEngineers.length<=1)return;const decay=0.95;const threshold=0.002;function step(){currentDisplayedIndex+=-velocity*0.8;rotateCarousel(currentDisplayedIndex,false);velocity*=decay;if(Math.abs(velocity)>threshold){inertiaFrame=requestAnimationFrame(step);}else{inertiaFrame=null;endDraggingWithAnimation();}}
step();}
function debounce(func,wait){let timeout;return function executedFunction(...args){const later=()=>{clearTimeout(timeout);func(...args);};clearTimeout(timeout);timeout=setTimeout(later,wait);};}
const debouncedWheel=debounce((direction)=>{triggerMovement(direction);},100);document.addEventListener("DOMContentLoaded",function(){try{initializeCarousel();const carouselContainer=document.querySelector(".carousel-container");if(carouselContainer){carouselContainer.style.touchAction="pan-y";console.log("Correction du défilement vertical appliquée");}
setupDeviceSpecificEventListeners();console.log("Carrousel initialisé avec succès");const style=document.createElement('style');style.textContent=`.sr-only{position:absolute!important;width:1px!important;height:1px!important;padding:0!important;margin:-1px!important;overflow:hidden!important;clip:rect(0,0,0,0)!important;white-space:nowrap!important;border:0!important;}`;document.head.appendChild(style);}catch(error){console.error("Erreur lors de l'initialisation:",error);}});